# BiGeaR ç®—æ³•å¤ç°

åŸºäº ReChorus æ¨èç³»ç»Ÿæ¡†æ¶å¤ç° KDD 2022 è®ºæ–‡ **"Learning Binarized Graph Representations with Multi-faceted Quantization Reinforcement for Top-K Recommendation"** (BiGeaR) ç®—æ³•ã€‚

## é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®åœ¨ [ReChorus](https://github.com/THUwangcy/ReChorus) æ¡†æ¶åŸºç¡€ä¸Šï¼Œå®ç°äº† BiGeaR äºŒå€¼åŒ–å›¾æ¨èç®—æ³•ã€‚BiGeaR é€šè¿‡å°†ç”¨æˆ·å’Œç‰©å“çš„åµŒå…¥å‘é‡äºŒå€¼åŒ–ï¼ˆé‡åŒ–ä¸º {-1, +1}ï¼‰ï¼Œåœ¨ä¿æŒæ¨èç²¾åº¦çš„åŒæ—¶å¤§å¹…é™ä½å­˜å‚¨å’Œè®¡ç®—å¼€é”€ã€‚

### è®ºæ–‡ä¿¡æ¯

- **è®ºæ–‡**: Learning Binarized Graph Representations with Multi-faceted Quantization Reinforcement for Top-K Recommendation
- **ä½œè€…**: Yankai Chen et al.
- **ä¼šè®®**: KDD 2022
- **é“¾æ¥**: https://dl.acm.org/doi/abs/10.1145/3534678.3539452

## BiGeaR ç®—æ³•æ ¸å¿ƒæ€æƒ³

### ä¸¤é˜¶æ®µè®­ç»ƒ

1. **Stage 1 - Teacher é¢„è®­ç»ƒ**: ä½¿ç”¨æ ‡å‡† LightGCN + BPR æŸå¤±è®­ç»ƒå…¨ç²¾åº¦æ¨¡å‹
2. **Stage 2 - Student è’¸é¦**: åŸºäº Teacher è¿›è¡ŒäºŒå€¼åŒ–è®­ç»ƒï¼Œä½¿ç”¨ ID æŸå¤±ä¿æŒæ’åä¸€è‡´æ€§

### å…³é”®æŠ€æœ¯

- **Normal_Ddelta äºŒå€¼åŒ–**: ä½¿ç”¨æ­£æ€åˆ†å¸ƒè¿‘ä¼¼ Dirac delta å‡½æ•°è¿›è¡Œæ¢¯åº¦ä¼°è®¡
  - Forward: `output = sign(x) Ã— mean(|x|)`
  - Backward: `grad = (a/âˆšÏ€) Ã— exp(-(ax)Â²)`

- **å±‚çº§åŠ æƒèšåˆ**: `Î»[l] = (l+1)/(L+1)`ï¼Œè¶Šæ·±å±‚æƒé‡è¶Šå¤§

- **Inference Distillation (ID) æŸå¤±**: è®© Student ä¿æŒ Teacher çš„ Top-R æ’å

## ç¯å¢ƒé…ç½®

### ä¾èµ–å®‰è£…

```bash
pip install -r requirements.txt
```

### ä¸»è¦ä¾èµ–

- Python 3.8+
- PyTorch 1.8+
- NumPy
- Pandas
- SciPy

## ä½¿ç”¨æ–¹æ³•

### Stage 1: Teacher é¢„è®­ç»ƒ

```bash
cd /path/to/project
python src/main.py \
    --model_name BiGeaR_LightGCN \
    --stage 1 \
    --dataset Grocery_and_Gourmet_Food \
    --emb_size 64 \
    --n_layers 2 \
    --lr 0.001 \
    --l2 1e-6 \
    --epoch 200 \
    --gpu 0
```

### Stage 2: Student è’¸é¦è®­ç»ƒ

```bash
python src/main.py \
    --model_name BiGeaR_LightGCN \
    --stage 2 \
    --dataset Grocery_and_Gourmet_Food \
    --emb_size 64 \
    --n_layers 2 \
    --lr 0.001 \
    --l2 1e-6 \
    --lambda_id 1.0 \
    --top_r 100 \
    --epoch 200 \
    --teacher_model_path <Stage1æ¨¡å‹è·¯å¾„> \
    --gpu 0
```

### ä¸»è¦å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--stage` | è®­ç»ƒé˜¶æ®µ (1=Teacher, 2=Student) | 1 |
| `--emb_size` | åµŒå…¥å‘é‡ç»´åº¦ | 256 |
| `--n_layers` | å›¾å·ç§¯å±‚æ•° | 2 |
| `--norm_a` | Dirac delta è¿‘ä¼¼å‚æ•° | 1.0 |
| `--lambda_id` | ID æŸå¤±æƒé‡ | 1.0 |
| `--top_r` | ID æŸå¤±ä¸­çš„ Top-R æ•°é‡ | 100 |
| `--teacher_model_path` | Stage 1 æ¨¡å‹è·¯å¾„ (Stage 2 å¿…éœ€) | - |

## å®éªŒç»“æœ

åœ¨ Grocery_and_Gourmet_Food æ•°æ®é›†ä¸Šçš„å¯¹æ¯”å®éªŒï¼ˆæ§åˆ¶å˜é‡ï¼šemb_size=64, n_layers=2, seed=0ï¼‰ï¼š

| æ¨¡å‹ | NDCG@5 | NDCG@10 | NDCG@20 | NDCG@50 |
|------|--------|---------|---------|---------|
| LightGCN (åŸºçº¿) | 0.2702 | 0.3101 | 0.3382 | 0.3775 |
| **BiGeaR Stage 1** (Teacher) | **0.2730** | **0.3114** | **0.3404** | **0.3797** |
| BiGeaR Stage 2 (Binary Student) | 0.2601 | 0.3005 | 0.3289 | 0.3691 |

### ğŸ¯ å…³é”®æŒ‡æ ‡ï¼šè¾¾åˆ°è®ºæ–‡ 95% æ€§èƒ½ä¿æŒæ ‡å‡†

| æŒ‡æ ‡ | Teacher | Binary Student | **ä¿æŒç‡** |
|------|---------|----------------|------------|
| NDCG@5 | 0.2730 | 0.2601 | **95.3%** |
| NDCG@10 | 0.3114 | 0.3005 | **96.5%** |
| NDCG@20 | 0.3404 | 0.3289 | **96.6%** |
| NDCG@50 | 0.3797 | 0.3691 | **97.2%** |

**âœ… å¤ç°æˆåŠŸï¼šäºŒå€¼åŒ– Student åœ¨æ‰€æœ‰æŒ‡æ ‡ä¸Šå‡è¾¾åˆ° Teacher çš„ 95% ä»¥ä¸Šæ€§èƒ½ï¼Œç¬¦åˆåŸè®ºæ–‡çš„æ ¸å¿ƒå£°æ˜ã€‚**

### ç»“æœåˆ†æ

1. **Stage 1 (Teacher)** ç›¸æ¯” LightGCN åŸºçº¿åœ¨æ‰€æœ‰æŒ‡æ ‡ä¸Šå‡æœ‰æå‡ï¼ŒéªŒè¯äº†å±‚çº§åŠ æƒèšåˆç­–ç•¥çš„æœ‰æ•ˆæ€§

2. **Stage 2 (Binary Student)** ä½¿ç”¨äºŒå€¼åŒ–åµŒå…¥ï¼Œæ€§èƒ½ä¿æŒç‡è¾¾ **95%~97%**ï¼ŒåŒæ—¶å¸¦æ¥æ˜¾è‘—ä¼˜åŠ¿ï¼š
   - å­˜å‚¨ç©ºé—´å‡å°‘ **32 å€**ï¼ˆ32-bit float â†’ 1-bit binaryï¼‰
   - æ”¯æŒ XNOR + Popcount åŠ é€Ÿæ¨ç†

## å®éªŒåˆ†æ

é™¤äº†åŸºç¡€çš„ç®—æ³•å¤ç°ï¼Œæœ¬é¡¹ç›®è¿˜è®¾è®¡äº†å››ç»„é¢å¤–çš„å®éªŒï¼Œæ·±å…¥åˆ†æ BiGeaR ç®—æ³•çš„ç‰¹æ€§å’Œé€‚ç”¨åœºæ™¯ã€‚ä¸‹é¢ä»…å±•ç¤ºå®éªŒç›®çš„å’Œç»“è®ºï¼Œè¯¦ç»†å®éªŒæ•°æ®è¯·å‚è€ƒæŠ¥å‘Šã€‚

### å®éªŒä¸€ï¼šæ¶ˆèå®éªŒï¼ˆLab/Lab1ï¼‰

**ç›®çš„**ï¼šéªŒè¯çŸ¥è¯†è’¸é¦ï¼ˆID Lossï¼‰æ¨¡å—çš„æœ‰æ•ˆæ€§

**ç»“è®º**ï¼šçŸ¥è¯†è’¸é¦æœ‰æ•ˆæå‡äºŒå€¼åŒ–æ¨¡å‹æ€§èƒ½ï¼Œä»£ä»·æ˜¯è®­ç»ƒæ—¶é—´å¢åŠ çº¦ 1/3ã€‚

### å®éªŒäºŒï¼šç”¨æˆ·æ´»è·ƒåº¦åˆ†æï¼ˆLab/Lab2ï¼‰

**ç›®çš„**ï¼šç ”ç©¶äºŒå€¼åŒ–å¯¹ä¸åŒæ´»è·ƒåº¦ç”¨æˆ·ç¾¤ä½“çš„å½±å“

**å…³é”®å‘ç°**ï¼š
- é«˜æ´»è·ƒç”¨æˆ·æ¨èæ•ˆæœæ˜¾è‘—ä¼˜äºä½æ´»è·ƒç”¨æˆ·ï¼ˆ+25%ï¼‰
- äºŒå€¼åŒ–å¯¹ä½æ´»è·ƒç”¨æˆ·å½±å“è¾ƒå°ï¼ˆå‡ ä¹æ— æŸå¤±ï¼‰
- äºŒå€¼åŒ–å¯¹é«˜æ´»è·ƒç”¨æˆ·å½±å“ç•¥å¤§ï¼ˆ-2.6%ï¼‰

### å®éªŒä¸‰ï¼šç‰©å“çƒ­é—¨åº¦åˆ†æï¼ˆLab/Lab3ï¼‰

**ç›®çš„**ï¼šç ”ç©¶äºŒå€¼åŒ–å¯¹çƒ­é—¨/å†·é—¨ç‰©å“æ¨èçš„å½±å“

**å…³é”®å‘ç°**ï¼š
- **äºŒå€¼åŒ–åŠ å‰§çƒ­é—¨åå·®**ï¼šçƒ­/å†·æ¯”å€¼ä» 3.42x ä¸Šå‡åˆ° 4.58x
- çƒ­é—¨ç‰©å“ï¼šäºŒå€¼åŒ–åæ€§èƒ½**æå‡ 3.5%**
- å†·é—¨ç‰©å“ï¼šäºŒå€¼åŒ–åæ€§èƒ½**ä¸‹é™ 22.6%**

### å®éªŒå››ï¼šè¶…å‚æ•°æ•æ„Ÿæ€§åˆ†æï¼ˆLab/Lab4ï¼‰

**ç›®çš„**ï¼šæ¢ç´¢ Embedding ç»´åº¦å¯¹æ€§èƒ½çš„å½±å“

**å…³é”®å‘ç°**ï¼š
- æ€§èƒ½éšç»´åº¦å•è°ƒé€’å¢ï¼Œæ”¶ç›Šé€’å‡
- é«˜ç»´åº¦ä¸‹äºŒå€¼åŒ–æŸå¤±æ›´å°ï¼ˆä¿æŒç‡ 94.6% â†’ 98.0%ï¼‰
- **æ¨èé…ç½®**ï¼šç»´åº¦ 64ï¼ˆå¹³è¡¡ï¼‰æˆ– 128ï¼ˆé«˜æ€§èƒ½ï¼‰

---

## é¡¹ç›®ç»“æ„

```
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.py                          # ä¸»ç¨‹åºå…¥å£
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ general/
â”‚   â”‚       â”œâ”€â”€ BiGeaR_LightGCN.py       # â­ BiGeaR ç®—æ³•å®ç°
â”‚   â”‚       â”œâ”€â”€ LightGCN.py              # LightGCN åŸºçº¿
â”‚   â”‚       â”œâ”€â”€ BPRMF.py                 # BPR-MF åŸºçº¿
â”‚   â”‚       â””â”€â”€ ...
â”‚   â”œâ”€â”€ helpers/                         # æ•°æ®è¯»å–å™¨
â”‚   â””â”€â”€ utils/                           # å·¥å…·å‡½æ•°
â”œâ”€â”€ data/
â”‚   â””â”€â”€ Grocery_and_Gourmet_Food/        # æ•°æ®é›†
â”œâ”€â”€ Lab/                                 # â­ é«˜çº§å®éªŒåˆ†æ
â”‚   â”œâ”€â”€ common/                          # å…¬å…±æ¨¡å—ï¼ˆåˆ†ç»„è¯„ä¼°å™¨ã€æ•°æ®ç»Ÿè®¡ï¼‰
â”‚   â”œâ”€â”€ Lab1/                            # æ¶ˆèå®éªŒ
â”‚   â”œâ”€â”€ Lab2/                            # ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ
â”‚   â”œâ”€â”€ Lab3/                            # ç‰©å“çƒ­é—¨åº¦åˆ†æ
â”‚   â”œâ”€â”€ Lab4/                            # è¶…å‚æ•°æ•æ„Ÿæ€§åˆ†æ
â”‚   â””â”€â”€ BiGeaR_å®éªŒæ€»ç»“æŠ¥å‘Š.md
â”œâ”€â”€ record/                              # å®éªŒè®°å½•
â”‚   â”œâ”€â”€ BiGeaR_LightGCN_v2/              # BiGeaR å®éªŒç»“æœ
â”‚   â”œâ”€â”€ LightGCN/                        # LightGCN åŸºçº¿ç»“æœ
â”‚   â””â”€â”€ BPRMF/                           # BPRMF åŸºçº¿ç»“æœ
â””â”€â”€ README.md
```

## æ ¸å¿ƒä»£ç è¯´æ˜

BiGeaR ç®—æ³•å®ç°ä½äº `src/models/general/BiGeaR_LightGCN.py`ï¼Œä¸»è¦åŒ…å«ï¼š

- `NormalDdelta`: äºŒå€¼åŒ–å‡½æ•°ï¼Œå®ç° STE æ¢¯åº¦ä¼°è®¡
- `QuantLayer`: é‡åŒ–å±‚å°è£…
- `BiGeaR_LightGCN`: ä¸»æ¨¡å‹ç±»
  - `_propagate_and_aggregate_teacher()`: Teacher å›¾ä¼ æ’­
  - `_propagate_and_quantize_student()`: Student äºŒå€¼åŒ–ä¼ æ’­
  - `_id_loss()`: Inference Distillation æŸå¤±
  - `_bpr_loss()`: BPR æ’åºæŸå¤±

## å‚è€ƒ

- åŸå§‹è®ºæ–‡: https://dl.acm.org/doi/abs/10.1145/3534678.3539452
- åŸå§‹ä»£ç : https://github.com/yankai-chen/BiGeaR
- ReChorus æ¡†æ¶: https://github.com/THUwangcy/ReChorus
